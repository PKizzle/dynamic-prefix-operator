name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v4.1.1

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.8.1"

      - name: Determine Prerelease Status
        id: prerelease
        # specific logic: if version contains a hyphen (e.g. 1.0.0-rc.1), it is a prerelease
        run: |
          if [[ "${{ github.ref_name }}" == *"-"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Render Chart.yaml from Template
        run: |
          # Define paths
          TEMPLATE_FILE="charts/dynamic-prefix-operator/Chart.template.yaml"
          CHART_FILE="charts/dynamic-prefix-operator/Chart.yaml"
          VALUES_FILE="charts/dynamic-prefix-operator/values.yaml"
          
          VERSION="${{ github.ref_name }}"
          IS_PRE="${{ steps.prerelease.outputs.is_prerelease }}"

          # Generate Chart.yaml from template
          sed -e "s/{{IS_PRERELEASE}}/$IS_PRE/g" \
              -e "s/^version: .*/version: $VERSION/" \
              -e "s/^appVersion: .*/appVersion: \"$VERSION\"/" \
              $TEMPLATE_FILE > $CHART_FILE

          # Update image tag in values.yaml to use the release version
          sed -i "s/tag:.*/tag: \"$VERSION\"/" $VALUES_FILE

      - name: Convert repository to lowercase
        id: repository
        uses: ASzc/change-string-case-action@v6
        with:
          string: ${{ github.repository }}

      - name: Generate install.yaml
        run: |
          # Update image in kustomize
          cd config/manager
          kustomize edit set image controller=${{ env.REGISTRY }}/${{ steps.repository.outputs.lowercase }}:${{ github.ref_name }}
          cd ../..

          # Build the full manifest
          kustomize build config/default > install.yaml

      - name: Package Helm chart
        run: |
          helm package charts/dynamic-prefix-operator --destination .

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Convert repository owner to lowercase
        id: repository_owner
        uses: ASzc/change-string-case-action@v6
        with:
          string: ${{ github.repository_owner }}

      - name: Push Helm chart to OCI registry
        run: |
          helm push dynamic-prefix-operator-${{ github.ref_name }}.tgz oci://${{ env.REGISTRY }}/${{ steps.repository_owner.outputs.lowercase }}/dynamic-prefix-operator/helm

      - name: Generate release notes
        id: notes
        run: |
          cat << 'EOF' > release-notes.md
          ## Installation

          ### Using Helm (recommended)

          ```bash
          helm install dynamic-prefix-operator \
            oci://ghcr.io/${{ steps.repository_owner.outputs.lowercase }}/dynamic-prefix-operator/helm/dynamic-prefix-operator \
            --version ${{ github.ref_name }}
          ```

          ### Using kubectl

          ```bash
          kubectl apply -f https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/install.yaml
          ```

          ## Docker Images

          Multi-arch images (amd64, arm64) are available at:

          ```
          ghcr.io/${{ steps.repository.outputs.lowercase }}:${{ github.ref_name }}
          ```

          ## What's Changed

          See the [commit history](https://github.com/${{ steps.repository.outputs.lowercase }}/commits/${{ github.ref_name }}) for details.
          EOF

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ github.ref_name }}"
          if gh release view "$tag" > /dev/null 2>&1; then
            gh release upload "$tag" install.yaml dynamic-prefix-operator-${{ github.ref_name }}.tgz --clobber
          else
            gh release create "$tag" \
              --target "${{ github.sha }}" \
              --generate-notes \
              install.yaml dynamic-prefix-operator-${{ github.ref_name }}.tgz
          fi
